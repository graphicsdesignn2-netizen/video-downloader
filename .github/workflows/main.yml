name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Create App Files
      run: |
        cat > main.py << 'EOF'
        from kivy.app import App
        from kivy.uix.boxlayout import BoxLayout
        from kivy.uix.label import Label
        from kivy.uix.textinput import TextInput
        from kivy.uix.button import Button
        from kivy.uix.popup import Popup
        from kivy.core.window import Window
        
        Window.clearcolor = (0.1, 0.1, 0.1, 1)
        
        class VideoDownloaderApp(App):
            def build(self):
                self.title = "Video Downloader"
                layout = BoxLayout(orientation='vertical', padding=20, spacing=12)
                
                header = Label(
                    text='[b][color=ff0000]VIDEO DOWNLOADER PRO[/color][/b]',
                    size_hint=(1, 0.18),
                    font_size='26sp',
                    markup=True
                )
                layout.add_widget(header)
                
                self.url_input = TextInput(
                    hint_text='Paste video URL here (YouTube, Facebook, etc.)',
                    multiline=False,
                    size_hint=(1, 0.12),
                    font_size='15sp'
                )
                layout.add_widget(self.url_input)
                
                download_btn = Button(
                    text='[b]DOWNLOAD VIDEO[/b]',
                    size_hint=(1, 0.12),
                    font_size='17sp',
                    markup=True,
                    background_color=(0, 0.75, 0, 1)
                )
                download_btn.bind(on_press=self.download_video)
                layout.add_widget(download_btn)
                
                self.status_label = Label(
                    text='Ready to download videos',
                    size_hint=(1, 0.35),
                    font_size='13sp',
                    color=(0.8, 0.8, 0.8, 1)
                )
                layout.add_widget(self.status_label)
                
                info_label = Label(
                    text='[color=888888]Supports YouTube, Facebook, Instagram,\nTwitter, TikTok and 500+ more sites[/color]',
                    size_hint=(1, 0.18),
                    font_size='11sp',
                    markup=True
                )
                layout.add_widget(info_label)
                
                return layout
            
            def download_video(self, instance):
                url = self.url_input.text.strip()
                if url:
                    self.status_label.text = f'URL Received:\n{url[:60]}...\n\nâœ… App is working!\nDownload feature will be added in next update.'
                    self.show_popup('Success', 'URL detected successfully!\n\nFull download feature coming soon.')
                else:
                    self.show_popup('Error', 'Please paste a video URL first!')
            
            def show_popup(self, title, message):
                content = BoxLayout(orientation='vertical', padding=15, spacing=10)
                
                msg_label = Label(
                    text=message,
                    font_size='14sp',
                    size_hint=(1, 0.7)
                )
                content.add_widget(msg_label)
                
                close_btn = Button(
                    text='OK',
                    size_hint=(1, 0.3),
                    font_size='15sp',
                    background_color=(0, 0.6, 1, 1)
                )
                content.add_widget(close_btn)
                
                popup = Popup(
                    title=title,
                    content=content,
                    size_hint=(0.85, 0.45),
                    auto_dismiss=False
                )
                close_btn.bind(on_press=popup.dismiss)
                popup.open()
        
        if __name__ == '__main__':
            VideoDownloaderApp().run()
        EOF
        
        cat > buildozer.spec << 'EOF'
        [app]
        title = Video Downloader Pro
        package.name = videodownloaderpro
        package.domain = org.videoapp
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3,kivy
        presplash.filename = 
        icon.filename = 
        orientation = portrait
        fullscreen = 0
        android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE
        android.api = 31
        android.minapi = 21
        android.ndk = 25b
        android.accept_sdk_license = True
        android.archs = armeabi-v7a
        
        [buildozer]
        log_level = 2
        warn_on_root = 1
        EOF
        
        ls -la
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          python3-dev \
          ffmpeg \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev \
          libsdl2-ttf-dev \
          libportmidi-dev \
          libswscale-dev \
          libavformat-dev \
          libavcodec-dev \
          zlib1g-dev \
          openjdk-11-jdk \
          autoconf \
          libtool \
          pkg-config
        
        python3 -m pip install --upgrade pip
        pip3 install --upgrade buildozer
        pip3 install --upgrade cython==0.29.33
    
    - name: Build APK
      run: |
        yes | buildozer -v android debug
    
    - name: List Files
      if: always()
      run: |
        echo "=== Current Directory ==="
        ls -la
        echo "=== Bin Directory ==="
        ls -la bin/ || echo "No bin directory"
        echo "=== Find APK files ==="
        find . -name "*.apk" -type f
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: VideoDownloaderPro-APK
        path: |
          bin/*.apk
          **/*.apk
        if-no-files-found: warn
    
    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
        tag_name: v1.0.${{ github.run_number }}
        name: Video Downloader v1.0.${{ github.run_number }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
