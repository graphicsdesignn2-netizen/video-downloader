name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Create Files
      run: |
        cat > main.py << 'MAINPY'
        from kivy.app import App
        from kivy.uix.boxlayout import BoxLayout
        from kivy.uix.label import Label
        from kivy.uix.textinput import TextInput
        from kivy.uix.button import Button
        from kivy.uix.popup import Popup
        
        class VideoApp(App):
            def build(self):
                layout = BoxLayout(orientation='vertical', padding=20, spacing=15)
                
                title = Label(text='[b][color=ff0000]VIDEO DOWNLOADER[/color][/b]',
                            size_hint=(1,0.2), font_size='28sp', markup=True)
                layout.add_widget(title)
                
                self.url_box = TextInput(hint_text='Paste video URL here',
                                        size_hint=(1,0.15), font_size='16sp')
                layout.add_widget(self.url_box)
                
                btn = Button(text='DOWNLOAD', size_hint=(1,0.15),
                           font_size='18sp', background_color=[0,0.8,0,1])
                btn.bind(on_press=self.start_download)
                layout.add_widget(btn)
                
                self.info = Label(text='Ready to download', size_hint=(1,0.3),
                                font_size='14sp', color=[0.7,0.7,0.7,1])
                layout.add_widget(self.info)
                
                footer = Label(text='Supports 500+ sites including YouTube',
                             size_hint=(1,0.2), font_size='12sp')
                layout.add_widget(footer)
                
                return layout
            
            def start_download(self, obj):
                url = self.url_box.text.strip()
                if url:
                    self.info.text = f'URL: {url[:40]}...\n\nDownload feature coming soon!'
                else:
                    self.show_msg('Error', 'Please paste a URL!')
            
            def show_msg(self, title, text):
                box = BoxLayout(orientation='vertical', padding=10)
                box.add_widget(Label(text=text, font_size='14sp'))
                ok = Button(text='OK', size_hint=(1,0.3), font_size='16sp')
                box.add_widget(ok)
                popup = Popup(title=title, content=box, size_hint=(0.85,0.4))
                ok.bind(on_press=popup.dismiss)
                popup.open()
        
        if __name__ == '__main__':
            VideoApp().run()
        MAINPY
        
        cat > buildozer.spec << 'SPEC'
        [app]
        title = Video Downloader
        package.name = videodown
        package.domain = org.myapp
        source.dir = .
        source.include_exts = py
        version = 1.0
        requirements = python3,kivy
        android.permissions = INTERNET,WRITE_EXTERNAL_STORAGE
        android.api = 31
        android.minapi = 21
        android.ndk = 25b
        android.accept_sdk_license = True
        android.archs = arm64-v8a
        orientation = portrait
        
        [buildozer]
        log_level = 2
        SPEC
    
    - name: Setup
      run: |
        sudo apt update
        sudo apt install -y python3-pip openjdk-11-jdk
        pip3 install buildozer cython==0.29.33
    
    - name: Build
      run: buildozer android debug || true
    
    - name: Upload
      uses: actions/upload-artifact@v3
      with:
        name: MyVideoDownloader-APK
        path: bin/*.apk
